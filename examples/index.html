<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReactPHP WebSocket Center Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4facfe;
        }

        button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.connecting {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.info {
            background: rgba(79, 172, 254, 0.2);
        }

        .log-entry.success {
            background: rgba(40, 167, 69, 0.2);
        }

        .log-entry.error {
            background: rgba(220, 53, 69, 0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .response-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .response-display h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .response-display pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }

        .connection-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .info-item label {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .info-item span {
            font-weight: 600;
            color: #333;
        }

        .chat-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .chat-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            word-wrap: break-word;
        }

        .chat-entry.received {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-entry.sent {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .chat-entry.system {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            font-style: italic;
        }

        .chat-timestamp {
            font-size: 11px;
            color: #666;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ReactPHP WebSocket Center Demo</h1>
            <p>Complete demonstration of all WebSocket Center methods and features</p>
            <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
                üåê This system supports distributed WebSocket service nodes architecture
            </p>
        </div>

        <div class="content">
            <!-- Connection Status -->
            <div class="section">
                <h2>üì° Connection Status</h2>
                <div id="connectionStatus" class="status disconnected">
                    Disconnected - Click Connect to start
                </div>
                <div class="connection-info">
                    <div class="info-item">
                        <label>Connection ID:</label>
                        <span id="connectionId">Not connected</span>
                    </div>
                    <div class="info-item">
                        <label>User ID:</label>
                        <span id="userId">Not bound</span>
                    </div>
                    <div class="info-item">
                        <label>Groups:</label>
                        <span id="userGroups">None</span>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="wsUrl">WebSocket URL:</label>
                        <input type="text" id="wsUrl" value="ws://10.10.10.2:8090?a=hello">
                    </div>
                    <div>
                        <label for="apiUrl">API URL:</label>
                        <input type="text" id="apiUrl" value="http://10.10.10.2:8011">
                    </div>
                    <div>
                        <button onclick="connectWebSocket()">Connect</button>
                        <button onclick="disconnectWebSocket()">Disconnect</button>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- User ID Binding -->
                <div class="section">
                    <h2>üë§ User ID Binding</h2>
                    <div class="form-group">
                        <label for="bindUserId">User ID to bind:</label>
                        <input type="number" id="bindUserId" value="1" placeholder="Enter user ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="bindUserId()">Bind Current Connection</button></div>
                        <div><button onclick="unbindUserId()">Unbind User ID</button></div>
                    </div>
                    <div class="form-group">
                        <label for="unbindConnectionId">Connection ID to unbind:</label>
                        <input type="text" id="unbindConnectionId" placeholder="Enter connection ID">
                    </div>
                    <button onclick="unbindConnectionId()">Unbind Connection ID</button>
                    <div id="bindingResponse" class="response-display" style="display: none;">
                        <h4>Response:</h4>
                        <pre id="bindingResult"></pre>
                    </div>
                </div>

                <!-- Group Management -->
                <div class="section">
                    <h2>üë• Group Management</h2>
                    <div class="form-group">
                        <label for="groupId">Group ID:</label>
                        <input type="text" id="groupId" value="room1" placeholder="Enter group ID">
                    </div>
                    <div class="form-group">
                        <label for="groupUserId">User ID for group operations:</label>
                        <input type="number" id="groupUserId" value="1" placeholder="Enter user ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="joinGroupById()">Join Group (by User ID)</button></div>
                        <div><button onclick="joinGroupByConnectionId()">Join Group (by Connection ID)</button></div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="leaveGroupById()">Leave Group (by User ID)</button></div>
                        <div><button onclick="leaveGroupByConnectionId()">Leave Group (by Connection ID)</button></div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="leaveAllGroupsById()">Leave All Groups (by User ID)</button></div>
                        <div><button onclick="leaveAllGroupsByConnectionId()">Leave All Groups (by Connection ID)</button></div>
                    </div>
                    <div id="groupResponse" class="response-display" style="display: none;">
                        <h4>Response:</h4>
                        <pre id="groupResult"></pre>
                    </div>
                </div>

                <!-- Message Sending -->
                <div class="section">
                    <h2>üí¨ Message Sending</h2>
                    <div class="form-group">
                        <label for="messageContent">Message Content:</label>
                        <textarea id="messageContent" rows="3" placeholder="Enter your message">Hello from ReactPHP ConnectionGroup!</textarea>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="targetUserId">Target User ID:</label>
                            <input type="number" id="targetUserId" value="1" placeholder="User ID">
                        </div>
                        <div>
                            <label for="targetConnectionId">Target Connection ID:</label>
                            <input type="text" id="targetConnectionId" placeholder="Connection ID">
                        </div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="sendToUserId()">Send to User ID</button></div>
                        <div><button onclick="sendToConnectionId()">Send to Connection ID</button></div>
                    </div>
                    <div class="form-group">
                        <label for="messageGroupId">Group ID for group messages:</label>
                        <input type="text" id="messageGroupId" value="room1" placeholder="Group ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="sendToGroup()">Send to Group</button></div>
                        <div><button onclick="broadcastMessage()">Broadcast to All</button></div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="sendToGroupByUserId()">Send to Group (by User ID)</button></div>
                        <div><button onclick="sendToGroupByConnectionId()">Send to Group (by Connection ID)</button></div>
                    </div>
                    <div id="messageResponse" class="response-display" style="display: none;">
                        <h4>Response:</h4>
                        <pre id="messageResult"></pre>
                    </div>
                </div>

                <!-- Query Operations -->
                <div class="section">
                    <h2>üîç Query Operations</h2>
                    <div class="form-row">
                        <div><button onclick="getConnectionCount()">Get Connection Count</button></div>
                        <div><button onclick="getAllUserIds()">Get All User IDs</button></div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="getAllConnectionIds()">Get All Connection IDs</button></div>
                        <div><button onclick="getAllGroupIds()">Get All Group IDs</button></div>
                    </div>
                    <div class="form-group">
                        <label for="queryUserId">User ID for queries:</label>
                        <input type="number" id="queryUserId" value="1" placeholder="Enter user ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="checkUserOnline()">Check if User Online</button></div>
                        <div><button onclick="getUserGroups()">Get User Groups</button></div>
                    </div>
                    <div class="form-group">
                        <label for="queryConnectionId">Connection ID for queries:</label>
                        <input type="text" id="queryConnectionId" placeholder="Enter connection ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="checkConnectionOnline()">Check if Connection Online</button></div>
                        <div><button onclick="getConnectionGroups()">Get Connection Groups</button></div>
                    </div>
                    <div class="form-group">
                        <label for="queryGroupId">Group ID for queries:</label>
                        <input type="text" id="queryGroupId" value="room1" placeholder="Enter group ID">
                    </div>
                    <div class="form-row">
                        <div><button onclick="checkUserInGroup()">Check User in Group</button></div>
                        <div><button onclick="checkConnectionInGroup()">Check Connection in Group</button></div>
                    </div>
                    <div class="form-row">
                        <div><button onclick="getGroupUserCount()">Get Group User Count</button></div>
                        <div><button onclick="getGroupConnectionCount()">Get Group Connection Count</button></div>
                    </div>
                    <div id="queryResponse" class="response-display" style="display: none;">
                        <h4>Response:</h4>
                        <pre id="queryResult"></pre>
                    </div>
                </div>


            </div>

            <!-- WebSocket Chat -->
            <div class="section">
                <h2>üí¨ WebSocket Chat</h2>
                <div class="form-row">
                    <div>
                        <button onclick="clearChat()" style="margin-bottom: 10px;">Clear Chat</button>
                    </div>
                    <div>
                        <button onclick="sendDirectMessage()" style="margin-bottom: 10px;">Send Direct Message</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="directMessage">Direct Message to WebSocket:</label>
                    <input type="text" id="directMessage" placeholder="Type your message..." value="Hello WebSocket!">
                </div>
                <div id="chatBox" class="chat-box">
                    <div class="chat-entry system">üí¨ WebSocket messages will appear here...</div>
                </div>
            </div>

            <!-- Message Log -->
            <div class="section">
                <h2>üìã Message Log</h2>
                <button onclick="clearLog()" style="margin-bottom: 10px;">Clear Log</button>
                <div id="messageLog" class="log">
                    <div class="log-entry info">üöÄ Welcome to ReactPHP ConnectionGroup Demo!</div>
                    <div class="log-entry info">üìù All operations will be logged here...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentConnectionId = null;
        let currentUserId = null;
        let apiBaseUrl = 'http://10.10.10.2:8011';

        // Utility functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function addChatMessage(message, type = 'received') {
            const chatBox = document.getElementById('chatBox');
            const entry = document.createElement('div');
            entry.className = `chat-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let icon = 'üì®';
            if (type === 'sent') icon = 'üì§';
            if (type === 'system') icon = 'üîî';
            
            entry.innerHTML = `<span class="chat-timestamp">[${timestamp}]</span>${icon} ${message}`;
            chatBox.appendChild(entry);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateConnectionInfo() {
            document.getElementById('connectionId').textContent = currentConnectionId || 'Not connected';
            document.getElementById('userId').textContent = currentUserId || 'Not bound';
            
            // Ëá™Âä®Ëé∑ÂèñÂπ∂ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑ÁöÑÂàÜÁªÑ‰ø°ÊÅØ
            if (currentUserId) {
                getUserGroupsForDisplay();
            } else {
                document.getElementById('userGroups').textContent = 'None';
            }
        }

        async function getUserGroupsForDisplay() {
            try {
                const result = await apiCall('getGroupIdsById', {
                    getGroupIdsById: { id: currentUserId }
                });
                
                if (result && result.data && result.data.getGroupIdsById) {
                    const allGroups = [];
                    Object.values(result.data.getGroupIdsById).forEach(groups => {
                        allGroups.push(...groups);
                    });
                    
                    const uniqueGroups = [...new Set(allGroups)];
                    document.getElementById('userGroups').textContent = 
                        uniqueGroups.length > 0 ? uniqueGroups.join(', ') : 'None';
                } else {
                    document.getElementById('userGroups').textContent = 'None';
                }
            } catch (error) {
                document.getElementById('userGroups').textContent = 'Error loading';
            }
        }

        function showResponse(containerId, resultId, data) {
            document.getElementById(containerId).style.display = 'block';
            const resultElement = document.getElementById(resultId);
            
            // Ê†ºÂºèÂåñÁâπÊÆäÊï∞ÊçÆÁªìÊûÑ
            if (data && data.data && data.data.getGroupIdsById) {
                let formattedText = `Status: ${data.code === 0 ? '‚úÖ Success' : '‚ùå Error'} (${data.msg})\n\n`;
                
                if (data.master_ids && data.master_ids.length > 0) {
                    formattedText += `üåê WebSocket Service Nodes (${data.master_ids.length}):\n`;
                    data.master_ids.forEach((id, index) => {
                        formattedText += `  ${index + 1}. Node ID: ${id}\n`;
                    });
                    formattedText += '\n';
                }
                
                formattedText += 'üë• Group Memberships by Service Node:\n';
                Object.entries(data.data.getGroupIdsById).forEach(([nodeId, groups]) => {
                    // Ê£ÄÊü•Ëøô‰∏™nodeIdÊòØÂê¶Âú®master_ids‰∏≠
                    const nodeIndex = data.master_ids ? data.master_ids.indexOf(nodeId) + 1 : '?';
                    formattedText += `üñ•Ô∏è Node ${nodeIndex} (${nodeId}):\n`;
                    if (groups.length === 0) {
                        formattedText += `    ‚îî‚îÄ‚îÄ (No groups joined)\n`;
                    } else {
                        groups.forEach((group, index) => {
                            const isLast = index === groups.length - 1;
                            formattedText += `    ${isLast ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ'} üè† ${group}\n`;
                        });
                    }
                    formattedText += '\n';
                });
                
                // ÁªüËÆ°ÊÄª‰ø°ÊÅØ
                const totalGroups = Object.values(data.data.getGroupIdsById).flat();
                const uniqueGroups = [...new Set(totalGroups)];
                formattedText += `üìä Summary:\n`;
                formattedText += `  ‚Ä¢ Total Service Nodes: ${data.master_ids ? data.master_ids.length : 0}\n`;
                formattedText += `  ‚Ä¢ Total Group Memberships: ${totalGroups.length}\n`;
                formattedText += `  ‚Ä¢ Unique Groups: ${uniqueGroups.length} (${uniqueGroups.join(', ') || 'None'})\n\n`;
                
                formattedText += 'üìä Raw Response:\n' + JSON.stringify(data, null, 2);
                resultElement.textContent = formattedText;
            } else if (data && typeof data === 'object') {
                // Ê†ºÂºèÂåñÊ†áÂáÜÂìçÂ∫î
                let formattedText = '';
                
                if (data.code !== undefined) {
                    formattedText += `Status: ${data.code === 0 ? '‚úÖ Success' : '‚ùå Error'} (Code: ${data.code})\n`;
                }
                
                if (data.msg) {
                    formattedText += `Message: ${data.msg}\n\n`;
                }
                
                if (data.data !== undefined) {
                    if (Array.isArray(data.data)) {
                        formattedText += `üìä Data (${data.data.length} items):\n`;
                        data.data.forEach((item, index) => {
                            formattedText += `  ${index + 1}. ${item}\n`;
                        });
                    } else if (typeof data.data === 'object') {
                        formattedText += 'üìä Data:\n';
                        Object.entries(data.data).forEach(([key, value]) => {
                            formattedText += `  ${key}: ${JSON.stringify(value)}\n`;
                        });
                    } else {
                        formattedText += `üìä Data: ${data.data}\n`;
                    }
                    formattedText += '\n';
                }
                
                if (data.master_ids && Array.isArray(data.master_ids)) {
                    formattedText += `üåê WebSocket Service Nodes (${data.master_ids.length}):\n`;
                    data.master_ids.forEach((id, index) => {
                        formattedText += `  ${index + 1}. Node ID: ${id}\n`;
                    });
                    formattedText += '\n';
                }
                
                formattedText += 'üìä Raw Response:\n' + JSON.stringify(data, null, 2);
                resultElement.textContent = formattedText;
            } else {
                // ÈªòËÆ§JSONÊ†ºÂºèÂåñ
                resultElement.textContent = JSON.stringify(data, null, 2);
            }
        }

        async function apiCall(event, params = {}) {
            try {
                const url = new URL(apiBaseUrl);
                url.searchParams.set('event', event);
                
                for (const [key, value] of Object.entries(params)) {
                    if (typeof value === 'object') {
                        for (const [subKey, subValue] of Object.entries(value)) {
                            url.searchParams.set(`${key}[${subKey}]`, subValue);
                        }
                    } else {
                        url.searchParams.set(key, value);
                    }
                }

                log(`üì° API Call: ${event} - ${url.toString()}`, 'info');
                
                const response = await fetch(url.toString());
                const data = await response.json();
                
                log(`‚úÖ API Response: ${JSON.stringify(data)}`, 'success');
                return data;
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // WebSocket Connection
        function connectWebSocket() {
            const wsUrl = document.getElementById('wsUrl').value;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('‚ö†Ô∏è Already connected', 'info');
                return;
            }

            log(`üîå Connecting to ${wsUrl}...`, 'info');
            document.getElementById('connectionStatus').className = 'status connecting';
            document.getElementById('connectionStatus').textContent = 'Connecting...';

            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(e) {
                log('‚úÖ WebSocket connected successfully!', 'success');
                addChatMessage('WebSocket connection established', 'system');
                document.getElementById('connectionStatus').className = 'status connected';
                document.getElementById('connectionStatus').textContent = 'Connected';
                ws.send('Hello from ConnectionGroup Demo!');
                addChatMessage('Hello from ConnectionGroup Demo!', 'sent');
            };

            ws.onmessage = function(e) {
                log(`üì® Received: ${e.data}`, 'info');
                addChatMessage(e.data, 'received');
                
                try {
                    const message = JSON.parse(e.data);
                    if (message._id && !currentConnectionId) {
                        currentConnectionId = message._id;
                        updateConnectionInfo();
                        log(`üÜî Connection ID received: ${message._id}`, 'success');
                        addChatMessage(`Connection ID assigned: ${message._id}`, 'system');
                    }
                } catch (error) {
                    // Not JSON, just regular message
                }
            };

            ws.onclose = function(e) {
                log('üîå WebSocket disconnected', 'info');
                addChatMessage('WebSocket connection closed', 'system');
                document.getElementById('connectionStatus').className = 'status disconnected';
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                currentConnectionId = null;
                currentUserId = null;
                updateConnectionInfo();
            };

            ws.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`, 'error');
                document.getElementById('connectionStatus').className = 'status disconnected';
                document.getElementById('connectionStatus').textContent = 'Connection Error';
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                log('üîå WebSocket disconnected manually', 'info');
                addChatMessage('WebSocket disconnected manually', 'system');
            }
        }

        function sendDirectMessage() {
            const message = document.getElementById('directMessage').value;
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket not connected', 'error');
                addChatMessage('Error: WebSocket not connected', 'system');
                return;
            }
            
            if (!message.trim()) {
                log('‚ùå Message cannot be empty', 'error');
                return;
            }
            
            ws.send(message);
            addChatMessage(message, 'sent');
            log(`üì§ Sent: ${message}`, 'info');
            document.getElementById('directMessage').value = '';
        }

        function clearChat() {
            document.getElementById('chatBox').innerHTML = '';
            addChatMessage('Chat cleared', 'system');
        }

        // User ID Binding Operations
        async function bindUserId() {
            const userId = document.getElementById('bindUserId').value;
            
            if (!currentConnectionId) {
                log('‚ùå No connection established', 'error');
                return;
            }

            try {
                const result = await apiCall('bindId', {
                    bindId: {
                        id: userId,
                        _id: currentConnectionId
                    }
                });
                
                if (result.code === 0) {
                    currentUserId = userId;
                    updateConnectionInfo();
                }
                
                showResponse('bindingResponse', 'bindingResult', result);
            } catch (error) {
                showResponse('bindingResponse', 'bindingResult', { error: error.message });
            }
        }

        async function unbindUserId() {
            const userId = document.getElementById('bindUserId').value;
            
            try {
                const result = await apiCall('unBindId', { unBindId: { id: userId } });
                
                if (result.code === 0) {
                    currentUserId = null;
                    updateConnectionInfo();
                }
                
                showResponse('bindingResponse', 'bindingResult', result);
            } catch (error) {
                showResponse('bindingResponse', 'bindingResult', { error: error.message });
            }
        }

        async function unbindConnectionId() {
            const connectionId = document.getElementById('unbindConnectionId').value || currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('unBind_Id', { unBind_Id: { _id: connectionId } });
                
                if (result.code === 0 && connectionId === currentConnectionId) {
                    currentUserId = null;
                    updateConnectionInfo();
                }
                
                showResponse('bindingResponse', 'bindingResult', result);
            } catch (error) {
                showResponse('bindingResponse', 'bindingResult', { error: error.message });
            }
        }

        // Group Management Operations
        async function joinGroupById() {
            const groupId = document.getElementById('groupId').value;
            const userId = document.getElementById('groupUserId').value;
            
            try {
                const result = await apiCall('joinGroupById', {
                    joinGroupById: {
                        groupId: groupId,
                        id: userId
                    }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÔºåÊõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                if (userId == currentUserId) {
                    setTimeout(() => updateConnectionInfo(), 500);
                }
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        async function joinGroupByConnectionId() {
            const groupId = document.getElementById('groupId').value;
            const connectionId = currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection established', 'error');
                return;
            }

            try {
                const result = await apiCall('joinGroupBy_Id', {
                    joinGroupBy_Id: {
                        groupId: groupId,
                        _id: connectionId
                    }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Êõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                setTimeout(() => updateConnectionInfo(), 500);
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        async function leaveGroupById() {
            const groupId = document.getElementById('groupId').value;
            const userId = document.getElementById('groupUserId').value;
            
            try {
                const result = await apiCall('leaveGroupById', {
                    leaveGroupById: {
                        groupId: groupId,
                        id: userId
                    }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÔºåÊõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                if (userId == currentUserId) {
                    setTimeout(() => updateConnectionInfo(), 500);
                }
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        async function leaveGroupByConnectionId() {
            const groupId = document.getElementById('groupId').value;
            const connectionId = currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection established', 'error');
                return;
            }

            try {
                const result = await apiCall('leaveGroupBy_Id', {
                    leaveGroupBy_Id: {
                        groupId: groupId,
                        _id: connectionId
                    }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Êõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                setTimeout(() => updateConnectionInfo(), 500);
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        async function leaveAllGroupsById() {
            const userId = document.getElementById('groupUserId').value;
            
            try {
                const result = await apiCall('leaveAllGroupById', {
                    leaveAllGroupById: { id: userId }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÔºåÊõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                if (userId == currentUserId) {
                    setTimeout(() => updateConnectionInfo(), 500);
                }
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        async function leaveAllGroupsByConnectionId() {
            const connectionId = currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection established', 'error');
                return;
            }

            try {
                const result = await apiCall('leaveAllGroupBy_Id', {
                    leaveAllGroupBy_Id: { _id: connectionId }
                });
                showResponse('groupResponse', 'groupResult', result);
                
                // Êõ¥Êñ∞ÂàÜÁªÑ‰ø°ÊÅØÊòæÁ§∫
                setTimeout(() => updateConnectionInfo(), 500);
            } catch (error) {
                showResponse('groupResponse', 'groupResult', { error: error.message });
            }
        }

        // Message Sending Operations
        async function sendToUserId() {
            const userId = document.getElementById('targetUserId').value;
            const message = document.getElementById('messageContent').value;
            
            try {
                const result = await apiCall('sendMessageToId', {
                    sendMessageToId: {
                        id: userId,
                        msg: message
                    }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        async function sendToConnectionId() {
            const connectionId = document.getElementById('targetConnectionId').value || currentConnectionId;
            const message = document.getElementById('messageContent').value;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('sendMessageTo_Id', {
                    sendMessageTo_Id: {
                        _id: connectionId,
                        msg: message
                    }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        async function sendToGroup() {
            const groupId = document.getElementById('messageGroupId').value;
            const message = document.getElementById('messageContent').value;
            
            try {
                const result = await apiCall('sendToGroup', {
                    sendToGroup: {
                        groupId: groupId,
                        msg: message
                    }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        async function broadcastMessage() {
            const message = document.getElementById('messageContent').value;
            
            try {
                const result = await apiCall('broadcast', {
                    broadcast: { msg: message }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        async function sendToGroupByUserId() {
            const userId = document.getElementById('targetUserId').value;
            const message = document.getElementById('messageContent').value;
            
            try {
                const result = await apiCall('sendMessageToGroupByOnlyId', {
                    sendMessageToGroupByOnlyId: {
                        id: userId,
                        msg: message
                    }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        async function sendToGroupByConnectionId() {
            const connectionId = document.getElementById('targetConnectionId').value || currentConnectionId;
            const message = document.getElementById('messageContent').value;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('sendMessageToGroupByOnly_Id', {
                    sendMessageToGroupByOnly_Id: {
                        _id: connectionId,
                        msg: message
                    }
                });
                showResponse('messageResponse', 'messageResult', result);
            } catch (error) {
                showResponse('messageResponse', 'messageResult', { error: error.message });
            }
        }

        // Query Operations
        async function getConnectionCount() {
            try {
                const result = await apiCall('getConnectionCount');
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getAllUserIds() {
            try {
                const result = await apiCall('getIds');
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getAllConnectionIds() {
            try {
                const result = await apiCall('get_Ids');
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getAllGroupIds() {
            try {
                const result = await apiCall('getGroupIds');
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function checkUserOnline() {
            const userId = document.getElementById('queryUserId').value;
            
            try {
                const result = await apiCall('isOnlineId', {
                    isOnlineId: { id: userId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getUserGroups() {
            const userId = document.getElementById('queryUserId').value;
            
            try {
                const result = await apiCall('getGroupIdsById', {
                    getGroupIdsById: { id: userId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function checkConnectionOnline() {
            const connectionId = document.getElementById('queryConnectionId').value || currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('isOnline_Id', {
                    isOnline_Id: { _id: connectionId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getConnectionGroups() {
            const connectionId = document.getElementById('queryConnectionId').value || currentConnectionId;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('getGroupIdsBy_Id', {
                    getGroupIdsBy_Id: { _id: connectionId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function checkUserInGroup() {
            const userId = document.getElementById('queryUserId').value;
            const groupId = document.getElementById('queryGroupId').value;
            
            try {
                const result = await apiCall('isInGroupById', {
                    isInGroupById: {
                        groupId: groupId,
                        id: userId
                    }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function checkConnectionInGroup() {
            const connectionId = document.getElementById('queryConnectionId').value || currentConnectionId;
            const groupId = document.getElementById('queryGroupId').value;
            
            if (!connectionId) {
                log('‚ùå No connection ID provided', 'error');
                return;
            }

            try {
                const result = await apiCall('isInGroupBy_Id', {
                    isInGroupBy_Id: {
                        groupId: groupId,
                        _id: connectionId
                    }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getGroupUserCount() {
            const groupId = document.getElementById('queryGroupId').value;
            
            try {
                const result = await apiCall('getGroupIdCount', {
                    getGroupIdCount: { groupId: groupId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }

        async function getGroupConnectionCount() {
            const groupId = document.getElementById('queryGroupId').value;
            
            try {
                const result = await apiCall('getGroup_IdCount', {
                    getGroup_IdCount: { groupId: groupId }
                });
                showResponse('queryResponse', 'queryResult', result);
            } catch (error) {
                showResponse('queryResponse', 'queryResult', { error: error.message });
            }
        }



        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
            log('üßπ Log cleared', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üéâ WebSocket Center Demo loaded successfully!', 'success');
            log('üåê This system supports distributed WebSocket service nodes', 'info');
            log('üìñ Instructions:', 'info');
            log('1. Click "Connect" to establish WebSocket connection', 'info');
            log('2. Bind your connection to a User ID', 'info');
            log('3. Join groups and send messages', 'info');
            log('4. Use query operations to inspect the distributed state', 'info');
            
            // Update API URL input
            document.getElementById('apiUrl').addEventListener('change', function() {
                apiBaseUrl = this.value;
                log(`üîß API URL updated to: ${apiBaseUrl}`, 'info');
            });

            // Add Enter key support for direct message
            document.getElementById('directMessage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendDirectMessage();
                }
            });
        });
    </script>
</body>

</html>